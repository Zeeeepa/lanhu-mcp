#!/bin/bash

# è“æ¹– MCP Docker å¿«é€Ÿéƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./setup-env.sh

set -e

echo "ðŸš€ è“æ¹– MCP Server - Docker éƒ¨ç½²åŠ©æ‰‹"
echo "======================================"
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# æ£€æŸ¥ Docker
echo "ðŸ“¦ æ£€æŸ¥ Docker çŽ¯å¢ƒ..."
if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ æœªå®‰è£… Dockerï¼Œè¯·å…ˆå®‰è£… Docker${NC}"
    echo "   å®˜æ–¹æ–‡æ¡£: https://docs.docker.com/get-docker/"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}âŒ æœªå®‰è£… Docker Composeï¼Œè¯·å…ˆå®‰è£…${NC}"
    echo "   å®˜æ–¹æ–‡æ¡£: https://docs.docker.com/compose/install/"
    exit 1
fi

echo -e "${GREEN}âœ… Docker çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡${NC}"
echo ""

# åˆ›å»º .env æ–‡ä»¶
echo "ðŸ“ åˆ›å»ºé…ç½®æ–‡ä»¶..."

# ä½ çš„è“æ¹– Cookie (å·²ä»Žç”¨æˆ·è¾“å…¥ä¸­èŽ·å–)
LANHU_COOKIE='your_lanhu_cookie_here'

cat > .env << EOF
# è“æ¹– MCP æœåŠ¡å™¨é…ç½®
# âš ï¸ æ³¨æ„ï¼šæ­¤æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦æäº¤åˆ° gitï¼

# ==============================================
# å¿…éœ€é…ç½®
# ==============================================

# è“æ¹– Cookieï¼ˆå¿…éœ€ï¼‰
LANHU_COOKIE="$LANHU_COOKIE"

# ==============================================
# æœåŠ¡å™¨é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==============================================

# æœåŠ¡å™¨ä¸»æœºåœ°å€
SERVER_HOST="0.0.0.0"

# æœåŠ¡å™¨ç«¯å£
SERVER_PORT=8000

# ==============================================
# é£žä¹¦æœºå™¨äººé…ç½®ï¼ˆå¯é€‰ï¼‰
# ==============================================

# é£žä¹¦ Webhook URLï¼ˆå¯é€‰ - å¦‚ä¸éœ€è¦é£žä¹¦é€šçŸ¥è¯·ç•™ç©ºï¼‰
FEISHU_WEBHOOK_URL=""

# ==============================================
# æ•°æ®å­˜å‚¨é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==============================================

# æ•°æ®å­˜å‚¨ç›®å½•
DATA_DIR="./data"

# ==============================================
# æ€§èƒ½é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==============================================

# HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
HTTP_TIMEOUT=30

# æµè§ˆå™¨è§†å£å®½åº¦
VIEWPORT_WIDTH=1920

# æµè§ˆå™¨è§†å£é«˜åº¦
VIEWPORT_HEIGHT=1080

# ==============================================
# å¼€å‘é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==============================================

# è°ƒè¯•æ¨¡å¼
DEBUG="false"
EOF

echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆ›å»ºæˆåŠŸ: .env${NC}"
chmod 600 .env
echo -e "${GREEN}âœ… å·²è®¾ç½®å®‰å…¨æƒé™ (600)${NC}"
echo ""

# åˆ›å»ºæ•°æ®ç›®å½•
echo "ðŸ“ åˆ›å»ºæ•°æ®ç›®å½•..."
mkdir -p data logs
echo -e "${GREEN}âœ… ç›®å½•åˆ›å»ºæˆåŠŸ${NC}"
echo ""

# æž„å»ºå’Œå¯åŠ¨
echo "ðŸ—ï¸  æž„å»º Docker é•œåƒ..."
echo -e "${YELLOW}â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...${NC}"
docker-compose build

echo ""
echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
docker-compose up -d

echo ""
echo "â±ï¸  ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ10ç§’ï¼‰..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo ""
echo "ðŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
if docker-compose ps | grep -q "Up"; then
    echo -e "${GREEN}âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼${NC}"
    echo ""
    echo "ðŸ“Š æœåŠ¡ä¿¡æ¯:"
    docker-compose ps
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "ðŸ“ æœåŠ¡è®¿é—®åœ°å€:"
    echo "   http://localhost:8000/mcp?role=å¼€å‘&name=ä½ çš„åå­—"
    echo ""
    echo "ðŸ”§ å¸¸ç”¨å‘½ä»¤:"
    echo "   æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f lanhu-mcp"
    echo "   åœæ­¢æœåŠ¡: docker-compose stop"
    echo "   é‡å¯æœåŠ¡: docker-compose restart"
    echo "   åˆ é™¤æœåŠ¡: docker-compose down"
    echo ""
    echo "ðŸ“š é…ç½® AI å®¢æˆ·ç«¯:"
    echo "   è¯·å‚è€ƒ DEPLOY.md æ–‡æ¡£ä¸­çš„ã€Œè¿žæŽ¥ AI å®¢æˆ·ç«¯ã€ç« èŠ‚"
    echo ""
    echo "ðŸ’¡ æç¤º:"
    echo "   - é…ç½®æ–‡ä»¶ä½ç½®: $(pwd)/.env"
    echo "   - æ•°æ®å­˜å‚¨ä½ç½®: $(pwd)/data"
    echo "   - æ—¥å¿—å­˜å‚¨ä½ç½®: $(pwd)/logs"
    echo ""
else
    echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¤±è´¥${NC}"
    echo ""
    echo "ðŸ“‹ æŸ¥çœ‹é”™è¯¯æ—¥å¿—:"
    docker-compose logs --tail=50 lanhu-mcp
    echo ""
    echo "ðŸ’¡ å¸¸è§é—®é¢˜æŽ’æŸ¥:"
    echo "   1. Cookie æ˜¯å¦æ­£ç¡®ï¼Ÿ"
    echo "   2. ç«¯å£ 8000 æ˜¯å¦è¢«å ç”¨ï¼Ÿ"
    echo "   3. Docker èµ„æºæ˜¯å¦å……è¶³ï¼Ÿ"
    echo ""
    echo "ðŸ“š è¯¦ç»†æ–‡æ¡£: è¯·æŸ¥çœ‹ DEPLOY.md"
    exit 1
fi

